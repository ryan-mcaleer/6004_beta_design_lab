.include "nominal.jsim"
.include "stdcell.jsim"
.include "program_counter.jsim"
.include "register_file.jsim"
.include "control_logic.jsim"
.include "beta_helpers.jsim"
.include "alu_wrapper.jsim"

.subckt beta clk reset ia[31:0] id[31:0] ma[31:0]
+ moe mrd[31:0] wr mwd[31:0]

* ========== INSTRUCTION FETCH ==========
    Xpc clk reset ia[31:0] pc

* ========== DECODE INSTRUCTION FIELDS ==========
    .connect opcode[5:0] id[31:26]
    .connect rc[4:0] id[25:21]
    .connect ra[4:0] id[20:16]
    .connect rb[4:0] id[15:11]
    .connect literal[15:0] id[15:0]

* ========== CONTROL LOGIC ==========
    Xctl reset opcode[5:0] ra2sel bsel alufn[5:0] wdsel[1:0] werf moe wr ctl

* ========== REGISTER FILE ==========
    Xregfile clk werf ra2sel ra[4:0] rb[4:0] rc[4:0]
    + wdata[31:0] radata[31:0] rbdata[31:0] regfile

* ========== DATAPATH ==========
    Xsext literal[15:0] sext_literal[31:0] signext16
    Xbsel_mux bsel rbdata[31:0] sext_literal[31:0] alu_b[31:0] mux2_32
    
* ALU output goes to internal signal alu_out
    Xalu alufn[5:0] radata[31:0] alu_b[31:0] alu_out[31:0] alu32

* ========== MEMORY INTERFACE ==========
* Connect internal signals to output ports using inverter pairs (acts like wire)
    Xinv_ma_a alu_out[31:0] ma_inv[31:0] inverter
    Xinv_ma_b ma_inv[31:0] ma[31:0] inverter
    
    Xinv_mwd_a rbdata[31:0] mwd_inv[31:0] inverter
    Xinv_mwd_b mwd_inv[31:0] mwd[31:0] inverter

* ========== WRITE-BACK ==========
    Xpc_inc ia[31:0] pc_plus4[31:0] inc32
    Xwdsel_mux wdsel[1:0] pc_plus4[31:0] alu_out[31:0] mrd[31:0] 0#32
    + wdata[31:0] mux4_32
.ends

.include "lab6basicblock.jsim"